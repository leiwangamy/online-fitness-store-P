{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block extra_css %}
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background-color: #d8f3dc; }
  table { border-collapse: collapse; width: 80%; max-width: 900px; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
  th { background-color: #f0f0f0; }
  .totals { margin-top: 20px; font-size: 1.05rem; }
  .totals p { margin: 4px 0; }
  .warning { color: red; font-weight: bold; margin: 15px 0; }
  .buttons { margin-top: 20px; }
  .buttons a, .buttons button { margin-right: 15px; padding: 8px 16px; font-size: 1rem; }
</style>
{% endblock %}

{% block content %}
<h1>Checkout</h1>

{% if empty %}
  <p>Your cart is empty.</p>
  <p><a href="{% url 'home:home' %}">Continue Shopping</a></p>
{% else %}

<form method="post">
  {% csrf_token %}

  <h2>Confirm Shipping Address</h2>

  <div style="background: #f9f9f9; padding: 15px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px;">
    <h3 style="margin-top: 0; margin-bottom: 10px;">Default Shipping Address</h3>
    {% if default_address.ship_address1 or default_address.ship_city %}
      <div style="line-height: 1.8;">
        {% if default_address.ship_name %}<strong>{{ default_address.ship_name }}</strong><br>{% endif %}
        {% if default_address.ship_phone %}Phone: {{ default_address.ship_phone }}<br>{% endif %}
        {% if default_address.ship_address1 %}{{ default_address.ship_address1 }}<br>{% endif %}
        {% if default_address.ship_address2 %}{{ default_address.ship_address2 }}<br>{% endif %}
        {% if default_address.ship_city or default_address.ship_province or default_address.ship_postal_code %}
          {% if default_address.ship_city %}{{ default_address.ship_city }}{% endif %}
          {% if default_address.ship_province %}, {{ default_address.ship_province }}{% endif %}
          {% if default_address.ship_postal_code %} {{ default_address.ship_postal_code }}{% endif %}
          <br>
        {% endif %}
        {% if default_address.ship_country %}{{ default_address.ship_country }}{% endif %}
      </div>
    {% else %}
      <p style="color: #666; font-style: italic;">No default address saved. Please fill in the form below or <a href="{% url 'profiles:address_edit' %}?next={{ request.path }}">edit your profile address</a>.</p>
    {% endif %}
    <div style="margin-top: 15px;">
      <a href="{% url 'profiles:address_edit' %}?next={{ request.path }}" style="padding: 6px 12px; background: #0066cc; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">
        Edit Address
      </a>
    </div>
  </div>

  <hr>

  <h3>Shipping Address Form</h3>
  <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">The form below is pre-filled with your default address. You can modify it if needed for this order.</p>

  {{ form.as_p }}

  {% if insufficient_items %}
    <div class="warning">
      Some items are not available in the requested quantity.
      Please go back to your cart and change the quantities.
    </div>
    <ul class="warning">
      {% for i in insufficient_items %}
        <li>{{ i.product.name }} â€“ requested: {{ i.requested }}, available: {{ i.available }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <h2>Order Summary</h2>
  <table>
    <tr>
      <th>Product</th>
      <th>Quantity</th>
      <th>Line Total</th>
    </tr>
    {% for item in items %}
      <tr>
        <td>{{ item.product.name }}</td>
        <td>{{ item.quantity }}</td>
        <td>${{ item.line_total }}</td>
      </tr>
    {% endfor %}
  </table>

  <div class="totals">
    <p>Subtotal: <strong>${{ subtotal }}</strong></p>
    <p>GST/HST (5%): <strong>${{ tax }}</strong></p>
    <p>Shipping: <strong>${{ shipping }}</strong> ({{ shipping_label }})</p>
    <p><strong>Total: ${{ total }}</strong></p>
  </div>

  <div class="buttons">
    {% if not insufficient_items %}
      <button type="submit" name="action" value="place_order">Place Order (demo)</button>
    {% else %}
      <a href="{% url 'cart:cart_detail' %}">Go back to Cart and adjust quantities</a>
    {% endif %}

    <a href="{% url 'home:home' %}">Continue Shopping</a>
    <a href="{% url 'cart:cart_detail' %}">Back to Cart</a>
  </div>

</form>

{% endif %}
{% endblock %}
