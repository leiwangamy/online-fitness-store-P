{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block extra_css %}
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background-color: #d8f3dc; }
  table { border-collapse: collapse; width: 80%; max-width: 900px; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
  th { background-color: #f0f0f0; }
  .totals { margin-top: 20px; font-size: 1.05rem; }
  .totals p { margin: 4px 0; }
  .warning { color: red; font-weight: bold; margin: 15px 0; }
  .buttons { margin-top: 20px; }
  .buttons a, .buttons button { margin-right: 15px; padding: 8px 16px; font-size: 1rem; }
  
  /* Two-column layout for fulfillment and address */
  .checkout-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 25px;
  }
  
  @media (max-width: 768px) {
    .checkout-options {
      grid-template-columns: 1fr;
    }
  }
  
  /* Fulfillment method styles */
  .fulfillment-method {
    padding: 15px;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 5px;
  }
  .fulfillment-method-radio {
    list-style: none;
    padding: 0;
    margin: 10px 0;
  }
  .fulfillment-method-radio li {
    margin: 8px 0;
  }
  .fulfillment-method-radio input[type="radio"] {
    margin-right: 8px;
  }
  .fulfillment-method-radio label {
    font-weight: normal;
    cursor: pointer;
  }
  
  /* Shipping address box */
  .shipping-address-box {
    padding: 15px;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 5px;
  }
  
  /* Pickup location styles */
  .pickup-location-select {
    margin-top: 10px;
    padding: 8px;
    width: 100%;
    max-width: 500px;
    font-size: 14px;
  }
  .pickup-location-info {
    margin-top: 10px;
    padding: 10px;
    background: #e8f5e9;
    border-left: 4px solid #4caf50;
    border-radius: 4px;
  }
  .pickup-location-info h4 {
    margin-top: 0;
    margin-bottom: 8px;
  }
  .pickup-location-info p {
    margin: 4px 0;
    line-height: 1.6;
  }
  
  /* Shipping form visibility */
  .shipping-form-section {
    margin-top: 20px;
  }
  .pickup-section {
    margin-top: 20px;
  }
</style>
{% endblock %}

{% block content %}
<h1>Checkout</h1>

{% if empty %}
  <p>Your cart is empty.</p>
  <p><a href="{% url 'home:home' %}">Continue Shopping</a></p>
{% elif digital_only %}
  {# Digital/Service only - no shipping/pickup needed, no address required #}
  <form method="post">
    {% csrf_token %}
    
    <h2>Order Summary</h2>
    <table>
      <tr>
        <th>Product</th>
        <th>Quantity</th>
        <th>Line Total</th>
      </tr>
      {% for item in items %}
        <tr>
          <td>{{ item.product.name }}</td>
          <td>{{ item.quantity }}</td>
          <td>${{ item.line_total }}</td>
        </tr>
      {% endfor %}
    </table>

    <div class="totals">
      <p>Subtotal: <strong>${{ subtotal }}</strong></p>
      <p>GST/HST (5%): <strong>${{ tax }}</strong></p>
      <p>Shipping: <strong>${{ shipping }}</strong> ({{ shipping_label }})</p>
      <p><strong>Total: ${{ total }}</strong></p>
    </div>

    <div class="buttons">
      {% if not insufficient_items %}
        <button type="submit" name="action" value="place_order">Place Order</button>
      {% else %}
        <a href="{% url 'cart:cart_detail' %}">Go back to Cart and adjust quantities</a>
      {% endif %}

      <a href="{% url 'home:home' %}">Continue Shopping</a>
      <a href="{% url 'cart:cart_detail' %}">Back to Cart</a>
    </div>
  </form>
{% else %}
  {# Physical products - show shipping/pickup form #}
  <form method="post">
    {% csrf_token %}

    <div class="checkout-options">
      <!-- Fulfillment Method Column -->
      <div class="fulfillment-method">
        <h3 style="margin-top: 0; margin-bottom: 10px;">Fulfillment Method</h3>
        <label><strong>How would you like to receive your order?</strong></label>
        <ul class="fulfillment-method-radio">
          <li>
            <input type="radio" 
                   name="fulfillment_method" 
                   value="shipping" 
                   id="id_fulfillment_method_0"
                   checked>
            <label for="id_fulfillment_method_0">Ship to Address</label>
          </li>
          <li>
            <input type="radio" 
                   name="fulfillment_method" 
                   value="pickup" 
                   id="id_fulfillment_method_1">
            <label for="id_fulfillment_method_1">Pick Up at Location</label>
          </li>
        </ul>
        {% if form.fulfillment_method.errors %}
          <div style="color: red; margin-top: 5px;">{{ form.fulfillment_method.errors }}</div>
        {% endif %}
      </div>

      <!-- Shipping Address Column -->
      <div class="shipping-address-box" id="shipping-section">
        <h3 style="margin-top: 0; margin-bottom: 10px;">Shipping Address</h3>
        {% if default_address.address1 or default_address.city %}
          <div style="line-height: 1.8;">
            {% if default_address.first_name or default_address.last_name %}
              <strong>
                {% if default_address.first_name %}{{ default_address.first_name }}{% endif %}
                {% if default_address.last_name %} {{ default_address.last_name }}{% endif %}
              </strong><br>
            {% endif %}
            {% if default_address.phone %}Phone: {{ default_address.phone }}<br>{% endif %}
            {% if default_address.address1 %}{{ default_address.address1 }}<br>{% endif %}
            {% if default_address.address2 %}{{ default_address.address2 }}<br>{% endif %}
            {% if default_address.city or default_address.province or default_address.postal_code %}
              {% if default_address.city %}{{ default_address.city }}{% endif %}
              {% if default_address.province %}, {{ default_address.province }}{% endif %}
              {% if default_address.postal_code %} {{ default_address.postal_code }}{% endif %}
              <br>
            {% endif %}
            {% if default_address.country %}{{ default_address.country }}{% endif %}
          </div>
        {% else %}
          <p style="color: #666; font-style: italic;">No default address saved. Please <a href="{% url 'profiles:address_edit' %}?next={{ request.path }}">add your address</a>.</p>
        {% endif %}
        <div style="margin-top: 15px;">
          <a href="{% url 'profiles:address_edit' %}?next={{ request.path }}" style="padding: 6px 12px; background: #0066cc; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">
            Edit Address
          </a>
        </div>
      </div>
    </div>

    {# Hidden fields with default address values - only show form fields if there are errors #}
    {% if form.errors %}
      <div id="shipping-form-fields" style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 5px;">
        <p style="color: #856404; font-weight: bold; margin-bottom: 10px;">Please correct the following errors:</p>
        <p>
          <label for="{{ form.first_name.id_for_label }}">{{ form.first_name.label }}:</label>
          {{ form.first_name }}
          {% if form.first_name.errors %}<span style="color: red;">{{ form.first_name.errors }}</span>{% endif %}
        </p>
        <p>
          <label for="{{ form.last_name.id_for_label }}">{{ form.last_name.label }}:</label>
          {{ form.last_name }}
          {% if form.last_name.errors %}<span style="color: red;">{{ form.last_name.errors }}</span>{% endif %}
        </p>
        <p>
          <label for="{{ form.phone.id_for_label }}">{{ form.phone.label }}:</label>
          {{ form.phone }}
          {% if form.phone.errors %}<span style="color: red;">{{ form.phone.errors }}</span>{% endif %}
        </p>
        <p>
          <label for="{{ form.address1.id_for_label }}">{{ form.address1.label }}:</label>
          {{ form.address1 }}
          {% if form.address1.errors %}<span style="color: red;">{{ form.address1.errors }}</span>{% endif %}
        </p>
        <p>
          <label for="{{ form.address2.id_for_label }}">{{ form.address2.label }}:</label>
          {{ form.address2 }}
          {% if form.address2.errors %}<span style="color: red;">{{ form.address2.errors }}</span>{% endif %}
        </p>
        <p>
          <label for="{{ form.city.id_for_label }}">{{ form.city.label }}:</label>
          {{ form.city }}
          {% if form.city.errors %}<span style="color: red;">{{ form.city.errors }}</span>{% endif %}
        </p>
        <p>
          <label for="{{ form.province.id_for_label }}">{{ form.province.label }}:</label>
          {{ form.province }}
          {% if form.province.errors %}<span style="color: red;">{{ form.province.errors }}</span>{% endif %}
        </p>
        <p>
          <label for="{{ form.postal_code.id_for_label }}">{{ form.postal_code.label }}:</label>
          {{ form.postal_code }}
          {% if form.postal_code.errors %}<span style="color: red;">{{ form.postal_code.errors }}</span>{% endif %}
        </p>
        <p>
          <label for="{{ form.country.id_for_label }}">{{ form.country.label }}:</label>
          {{ form.country }}
          {% if form.country.errors %}<span style="color: red;">{{ form.country.errors }}</span>{% endif %}
        </p>
      </div>
    {% else %}
      {# Hidden fields with default values #}
      <input type="hidden" name="first_name" value="{{ default_address.first_name|default:'' }}">
      <input type="hidden" name="last_name" value="{{ default_address.last_name|default:'' }}">
      <input type="hidden" name="phone" value="{{ default_address.phone|default:'' }}">
      <input type="hidden" name="address1" value="{{ default_address.address1|default:'' }}">
      <input type="hidden" name="address2" value="{{ default_address.address2|default:'' }}">
      <input type="hidden" name="city" value="{{ default_address.city|default:'' }}">
      <input type="hidden" name="province" value="{{ default_address.province|default:'' }}">
      <input type="hidden" name="postal_code" value="{{ default_address.postal_code|default:'' }}">
      <input type="hidden" name="country" value="{{ default_address.country|default:'Canada' }}">
    {% endif %}
  </div>

  <!-- Pickup Location Section - shown below when pickup is selected -->
  <div class="pickup-section" id="pickup-section" style="display: none; margin-top: 20px;">
    <h3>Select Pickup Location</h3>
    {% if pickup_locations %}
      <p>
        <label for="id_pickup_location_id">Pickup Location:</label>
        <select name="pickup_location_id" id="id_pickup_location_id" class="pickup-location-select">
          <option value="">Select a pickup location</option>
          {% for location in pickup_locations %}
            <option value="{{ location.id }}">{{ location.name }}</option>
          {% endfor %}
        </select>
        {% if form.pickup_location_id.errors %}<span style="color: red;">{{ form.pickup_location_id.errors }}</span>{% endif %}
      </p>
      <div id="pickup-location-details" style="display: none;" class="pickup-location-info"></div>
    {% else %}
      <p style="color: #666; font-style: italic;">No pickup locations available at this time. Please select shipping instead.</p>
      <input type="hidden" name="pickup_location_id" id="id_pickup_location_id" value="">
    {% endif %}
  </div>

  {% if insufficient_items %}
    <div class="warning">
      Some items are not available in the requested quantity.
      Please go back to your cart and change the quantities.
    </div>
    <ul class="warning">
      {% for i in insufficient_items %}
        <li>{{ i.product.name }} â€“ requested: {{ i.requested }}, available: {{ i.available }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <h2>Order Summary</h2>
  <table>
    <tr>
      <th>Product</th>
      <th>Quantity</th>
      <th>Line Total</th>
    </tr>
    {% for item in items %}
      <tr>
        <td>{{ item.product.name }}</td>
        <td>{{ item.quantity }}</td>
        <td>${{ item.line_total }}</td>
      </tr>
    {% endfor %}
  </table>

  <div class="totals">
    <p>Subtotal: <strong id="subtotal-display">${{ subtotal }}</strong></p>
    <p>GST/HST (5%): <strong id="tax-display">${{ tax }}</strong></p>
    <p>Shipping: <strong id="shipping-display">${{ shipping }}</strong> (<span id="shipping-label">{{ shipping_label }}</span>)</p>
    <p><strong>Total: <span id="total-display">${{ total }}</span></strong></p>
  </div>

  <div class="buttons">
    {% if not insufficient_items %}
      <button type="submit" name="action" value="place_order" id="place-order-btn">Place Order (demo)</button>
    {% else %}
      <a href="{% url 'cart:cart_detail' %}">Go back to Cart and adjust quantities</a>
    {% endif %}

    <a href="{% url 'home:home' %}">Continue Shopping</a>
    <a href="{% url 'cart:cart_detail' %}">Back to Cart</a>
  </div>
  
  {# Error message for missing pickup location #}
  <div id="pickup-location-error" style="display: none; color: red; font-weight: bold; margin-top: 15px; padding: 10px; background: #ffe6e6; border: 1px solid #ff9999; border-radius: 4px;">
    Please select a pickup location before placing your order.
  </div>

</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const fulfillmentRadios = document.querySelectorAll('input[name="fulfillment_method"]');
  const shippingSection = document.getElementById('shipping-section');
  const pickupSection = document.getElementById('pickup-section');
  {% if form.pickup_location_id %}
  const pickupSelect = document.getElementById('{{ form.pickup_location_id.id_for_label }}');
  {% else %}
  const pickupSelect = document.getElementById('id_pickup_location_id');
  {% endif %}
  const pickupDetails = document.getElementById('pickup-location-details');
  
  // Pickup locations data for JavaScript
  const pickupLocations = {
    {% for location in pickup_locations %}
    {{ location.id }}: {
      name: "{{ location.name|escapejs }}",
      address1: "{{ location.address1|escapejs }}",
      address2: "{{ location.address2|default:''|escapejs }}",
      city: "{{ location.city|escapejs }}",
      province: "{{ location.province|escapejs }}",
      postal_code: "{{ location.postal_code|escapejs }}",
      country: "{{ location.country|escapejs }}",
      phone: "{{ location.phone|default:''|escapejs }}",
      instructions: "{{ location.instructions|default:''|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  };
  
  function updateShippingCost() {
    const selectedMethod = document.querySelector('input[name="fulfillment_method"]:checked');
    const subtotalEl = document.getElementById('subtotal-display');
    const taxEl = document.getElementById('tax-display');
    const shippingEl = document.getElementById('shipping-display');
    const shippingLabelEl = document.getElementById('shipping-label');
    const totalEl = document.getElementById('total-display');
    
    if (!subtotalEl || !taxEl || !shippingEl || !totalEl) return;
    
    // Extract numeric values from the original display
    const subtotal = parseFloat('{{ subtotal }}');
    const tax = parseFloat('{{ tax }}');
    const originalShipping = parseFloat('{{ shipping }}');
    const originalShippingLabel = '{{ shipping_label|escapejs }}';
    
    let shipping = originalShipping;
    let shippingLabel = originalShippingLabel;
    
    // If pickup is selected, shipping is $0
    if (selectedMethod && selectedMethod.value === 'pickup') {
      shipping = 0;
      shippingLabel = 'No shipping (pickup order)';
    }
    
    const total = subtotal + tax + shipping;
    
    // Update display
    shippingEl.textContent = '$' + shipping.toFixed(2);
    if (shippingLabelEl) shippingLabelEl.textContent = shippingLabel;
    totalEl.textContent = '$' + total.toFixed(2);
  }
  
  function toggleFulfillmentSections() {
    const selectedMethod = document.querySelector('input[name="fulfillment_method"]:checked');
    if (selectedMethod && selectedMethod.value === 'pickup') {
      if (shippingSection) shippingSection.style.display = 'none';
      if (pickupSection) pickupSection.style.display = 'block';
      // Make shipping fields not required when pickup is selected
      if (shippingSection) {
        const shippingFields = shippingSection.querySelectorAll('input[required], select[required]');
        shippingFields.forEach(field => field.removeAttribute('required'));
      }
      // Make pickup location required when pickup is selected
      if (pickupSelect) {
        pickupSelect.setAttribute('required', 'required');
      }
    } else {
      if (shippingSection) shippingSection.style.display = 'block';
      if (pickupSection) pickupSection.style.display = 'none';
      // Make shipping fields required when shipping is selected
      const requiredFields = ['first_name', 'last_name', 'address1', 'city', 'province', 'postal_code'];
      requiredFields.forEach(fieldName => {
        const field = document.getElementById('id_' + fieldName);
        if (field) field.setAttribute('required', 'required');
      });
      // Remove required from pickup location when shipping is selected
      if (pickupSelect) {
        pickupSelect.removeAttribute('required');
      }
    }
    // Update shipping cost when method changes
    updateShippingCost();
  }
  
  function updatePickupDetails() {
    if (!pickupSelect || !pickupDetails) return;
    const selectedId = pickupSelect.value;
    if (selectedId && pickupLocations[selectedId]) {
      const loc = pickupLocations[selectedId];
      let html = '<h4>' + loc.name + '</h4>';
      html += '<p><strong>Address:</strong><br>';
      html += loc.address1;
      if (loc.address2) html += '<br>' + loc.address2;
      html += '<br>' + loc.city + ', ' + loc.province + ' ' + loc.postal_code;
      html += '<br>' + loc.country + '</p>';
      if (loc.phone) html += '<p><strong>Phone:</strong> ' + loc.phone + '</p>';
      if (loc.instructions) html += '<p><strong>Instructions:</strong> ' + loc.instructions + '</p>';
      pickupDetails.innerHTML = html;
      pickupDetails.style.display = 'block';
    } else {
      pickupDetails.style.display = 'none';
    }
  }
  
  // Initial setup - set default to shipping if nothing is checked
  if (!document.querySelector('input[name="fulfillment_method"]:checked')) {
    const shippingRadio = document.getElementById('id_fulfillment_method_0');
    if (shippingRadio) shippingRadio.checked = true;
  }
  toggleFulfillmentSections();
  
  // Listen for fulfillment method changes
  fulfillmentRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      toggleFulfillmentSections();
      updateShippingCost();
    });
  });
  
  // Listen for pickup location selection
  if (pickupSelect) {
    pickupSelect.addEventListener('change', function() {
      updatePickupDetails();
      // Clear error when location is selected
      if (pickupLocationError) {
        pickupLocationError.style.display = 'none';
      }
      if (pickupSelect.style.border === '2px solid red') {
        pickupSelect.style.border = '';
      }
    });
    // Update on page load if a location is already selected
    if (pickupSelect.value) {
      updatePickupDetails();
    }
  }
  
  // Form validation before submission
  const form = document.querySelector('form');
  const pickupLocationError = document.getElementById('pickup-location-error');
  
  if (form) {
    form.addEventListener('submit', function(e) {
      const selectedMethod = document.querySelector('input[name="fulfillment_method"]:checked');
      
      // Check if pickup is selected but no location is chosen
      if (selectedMethod && selectedMethod.value === 'pickup') {
        // Get pickup select element (might be in different scope)
        const pickupSelectEl = document.getElementById('id_pickup_location_id');
        const pickupSelectValue = pickupSelectEl ? pickupSelectEl.value : '';
        
        if (!pickupSelectValue || pickupSelectValue === '' || pickupSelectValue === '0') {
          e.preventDefault(); // Prevent form submission
          e.stopPropagation(); // Stop event from bubbling
          
          // Show error message
          if (pickupLocationError) {
            pickupLocationError.style.display = 'block';
            pickupLocationError.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
          
          // Highlight the pickup location dropdown
          if (pickupSelectEl) {
            pickupSelectEl.style.border = '2px solid red';
            pickupSelectEl.style.backgroundColor = '#ffe6e6';
            pickupSelectEl.focus();
            
            // Remove highlight when user selects a location
            pickupSelectEl.addEventListener('change', function() {
              if (this.value && this.value !== '' && this.value !== '0') {
                this.style.border = '';
                this.style.backgroundColor = '';
                if (pickupLocationError) {
                  pickupLocationError.style.display = 'none';
                }
              }
            }, { once: true });
          }
          
          return false;
        }
      }
      
      // Hide error if validation passes
      if (pickupLocationError) {
        pickupLocationError.style.display = 'none';
      }
    });
  }
});
</script>

{% endif %}
{% endblock %}
