{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block extra_css %}
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background-color: #d8f3dc; }
  table { border-collapse: collapse; width: 80%; max-width: 900px; background: #fff; }
  th, td { border: 1px solid #ccc; padding: 8px 10px; text-align: left; }
  th { background-color: #f0f0f0; }
  .totals { margin-top: 20px; font-size: 1.05rem; }
  .totals p { margin: 4px 0; }
  .warning { color: red; font-weight: bold; margin: 15px 0; }
  .buttons { margin-top: 20px; }
  .buttons a, .buttons button { margin-right: 15px; padding: 8px 16px; font-size: 1rem; }
  
  /* Fulfillment method styles */
  .fulfillment-method {
    margin-bottom: 25px;
    padding: 15px;
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 5px;
  }
  .fulfillment-method-radio {
    list-style: none;
    padding: 0;
    margin: 10px 0;
  }
  .fulfillment-method-radio li {
    margin: 8px 0;
  }
  .fulfillment-method-radio input[type="radio"] {
    margin-right: 8px;
  }
  .fulfillment-method-radio label {
    font-weight: normal;
    cursor: pointer;
  }
  
  /* Pickup location styles */
  .pickup-location-select {
    margin-top: 10px;
    padding: 8px;
    width: 100%;
    max-width: 500px;
    font-size: 14px;
  }
  .pickup-location-info {
    margin-top: 10px;
    padding: 10px;
    background: #e8f5e9;
    border-left: 4px solid #4caf50;
    border-radius: 4px;
  }
  .pickup-location-info h4 {
    margin-top: 0;
    margin-bottom: 8px;
  }
  .pickup-location-info p {
    margin: 4px 0;
    line-height: 1.6;
  }
  
  /* Shipping form visibility */
  .shipping-form-section {
    margin-top: 20px;
  }
  .pickup-section {
    margin-top: 20px;
  }
</style>
{% endblock %}

{% block content %}
<h1>Checkout</h1>

{% if empty %}
  <p>Your cart is empty.</p>
  <p><a href="{% url 'home:home' %}">Continue Shopping</a></p>
{% elif digital_only %}
  {# Digital/Service only - no shipping needed #}
  <form method="post">
    {% csrf_token %}
    
    <h2>Order Summary</h2>
    <table>
      <tr>
        <th>Product</th>
        <th>Quantity</th>
        <th>Line Total</th>
      </tr>
      {% for item in items %}
        <tr>
          <td>{{ item.product.name }}</td>
          <td>{{ item.quantity }}</td>
          <td>${{ item.line_total }}</td>
        </tr>
      {% endfor %}
    </table>

    <div class="totals">
      <p>Subtotal: <strong>${{ subtotal }}</strong></p>
      <p>GST/HST (5%): <strong>${{ tax }}</strong></p>
      <p>Shipping: <strong>${{ shipping }}</strong> ({{ shipping_label }})</p>
      <p><strong>Total: ${{ total }}</strong></p>
    </div>

    <div class="buttons">
      {% if not insufficient_items %}
        <button type="submit" name="action" value="place_order">Place Order</button>
      {% else %}
        <a href="{% url 'cart:cart_detail' %}">Go back to Cart and adjust quantities</a>
      {% endif %}

      <a href="{% url 'home:home' %}">Continue Shopping</a>
      <a href="{% url 'cart:cart_detail' %}">Back to Cart</a>
    </div>
  </form>
{% else %}
  {# Physical products - show shipping/pickup form #}
  <form method="post">
    {% csrf_token %}

    <h2>Fulfillment Method</h2>
  
  <div class="fulfillment-method">
    <label><strong>How would you like to receive your order?</strong></label>
    <ul class="fulfillment-method-radio">
      <li>
        <input type="radio" 
               name="fulfillment_method" 
               value="shipping" 
               id="id_fulfillment_method_0"
               checked>
        <label for="id_fulfillment_method_0">Ship to Address</label>
      </li>
      <li>
        <input type="radio" 
               name="fulfillment_method" 
               value="pickup" 
               id="id_fulfillment_method_1">
        <label for="id_fulfillment_method_1">Pick Up at Location</label>
      </li>
    </ul>
    {% if form.fulfillment_method.errors %}
      <div style="color: red; margin-top: 5px;">{{ form.fulfillment_method.errors }}</div>
    {% endif %}
  </div>

  <!-- Shipping Address Section -->
  <div class="shipping-form-section" id="shipping-section">
    <h3>Shipping Address</h3>
    
    <div style="background: #f9f9f9; padding: 15px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 20px;">
      <h4 style="margin-top: 0; margin-bottom: 10px;">Default Shipping Address</h4>
      {% if default_address.ship_address1 or default_address.ship_city %}
        <div style="line-height: 1.8;">
          {% if default_address.ship_name %}<strong>{{ default_address.ship_name }}</strong><br>{% endif %}
          {% if default_address.ship_phone %}Phone: {{ default_address.ship_phone }}<br>{% endif %}
          {% if default_address.ship_address1 %}{{ default_address.ship_address1 }}<br>{% endif %}
          {% if default_address.ship_address2 %}{{ default_address.ship_address2 }}<br>{% endif %}
          {% if default_address.ship_city or default_address.ship_province or default_address.ship_postal_code %}
            {% if default_address.ship_city %}{{ default_address.ship_city }}{% endif %}
            {% if default_address.ship_province %}, {{ default_address.ship_province }}{% endif %}
            {% if default_address.ship_postal_code %} {{ default_address.ship_postal_code }}{% endif %}
            <br>
          {% endif %}
          {% if default_address.ship_country %}{{ default_address.ship_country }}{% endif %}
        </div>
      {% else %}
        <p style="color: #666; font-style: italic;">No default address saved. Please fill in the form below or <a href="{% url 'profiles:address_edit' %}?next={{ request.path }}">edit your profile address</a>.</p>
      {% endif %}
      <div style="margin-top: 15px;">
        <a href="{% url 'profiles:address_edit' %}?next={{ request.path }}" style="padding: 6px 12px; background: #0066cc; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">
          Edit Address
        </a>
      </div>
    </div>

    <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">The form below is pre-filled with your default address. You can modify it if needed for this order.</p>

    <div id="shipping-form-fields">
      <p>
        <label for="{{ form.ship_name.id_for_label }}">{{ form.ship_name.label }}:</label>
        {{ form.ship_name }}
        {% if form.ship_name.errors %}<span style="color: red;">{{ form.ship_name.errors }}</span>{% endif %}
      </p>
      <p>
        <label for="{{ form.ship_phone.id_for_label }}">{{ form.ship_phone.label }}:</label>
        {{ form.ship_phone }}
        {% if form.ship_phone.errors %}<span style="color: red;">{{ form.ship_phone.errors }}</span>{% endif %}
      </p>
      <p>
        <label for="{{ form.ship_address1.id_for_label }}">{{ form.ship_address1.label }}:</label>
        {{ form.ship_address1 }}
        {% if form.ship_address1.errors %}<span style="color: red;">{{ form.ship_address1.errors }}</span>{% endif %}
      </p>
      <p>
        <label for="{{ form.ship_address2.id_for_label }}">{{ form.ship_address2.label }}:</label>
        {{ form.ship_address2 }}
        {% if form.ship_address2.errors %}<span style="color: red;">{{ form.ship_address2.errors }}</span>{% endif %}
      </p>
      <p>
        <label for="{{ form.ship_city.id_for_label }}">{{ form.ship_city.label }}:</label>
        {{ form.ship_city }}
        {% if form.ship_city.errors %}<span style="color: red;">{{ form.ship_city.errors }}</span>{% endif %}
      </p>
      <p>
        <label for="{{ form.ship_province.id_for_label }}">{{ form.ship_province.label }}:</label>
        {{ form.ship_province }}
        {% if form.ship_province.errors %}<span style="color: red;">{{ form.ship_province.errors }}</span>{% endif %}
      </p>
      <p>
        <label for="{{ form.ship_postal_code.id_for_label }}">{{ form.ship_postal_code.label }}:</label>
        {{ form.ship_postal_code }}
        {% if form.ship_postal_code.errors %}<span style="color: red;">{{ form.ship_postal_code.errors }}</span>{% endif %}
      </p>
      <p>
        <label for="{{ form.ship_country.id_for_label }}">{{ form.ship_country.label }}:</label>
        {{ form.ship_country }}
        {% if form.ship_country.errors %}<span style="color: red;">{{ form.ship_country.errors }}</span>{% endif %}
      </p>
    </div>
  </div>

  <!-- Pickup Location Section -->
  <div class="pickup-section" id="pickup-section" style="display: none;">
    <h3>Select Pickup Location</h3>
    {% if pickup_locations %}
      <p>
        <label for="id_pickup_location_id">Pickup Location:</label>
        <select name="pickup_location_id" id="id_pickup_location_id" class="pickup-location-select">
          <option value="">Select a pickup location</option>
          {% for location in pickup_locations %}
            <option value="{{ location.id }}">{{ location.name }}</option>
          {% endfor %}
        </select>
        {% if form.pickup_location_id.errors %}<span style="color: red;">{{ form.pickup_location_id.errors }}</span>{% endif %}
      </p>
      <div id="pickup-location-details" style="display: none;" class="pickup-location-info"></div>
    {% else %}
      <p style="color: #666; font-style: italic;">No pickup locations available at this time. Please select shipping instead.</p>
      <input type="hidden" name="pickup_location_id" id="id_pickup_location_id" value="">
    {% endif %}
  </div>

  {% if insufficient_items %}
    <div class="warning">
      Some items are not available in the requested quantity.
      Please go back to your cart and change the quantities.
    </div>
    <ul class="warning">
      {% for i in insufficient_items %}
        <li>{{ i.product.name }} â€“ requested: {{ i.requested }}, available: {{ i.available }}</li>
      {% endfor %}
    </ul>
  {% endif %}

  <h2>Order Summary</h2>
  <table>
    <tr>
      <th>Product</th>
      <th>Quantity</th>
      <th>Line Total</th>
    </tr>
    {% for item in items %}
      <tr>
        <td>{{ item.product.name }}</td>
        <td>{{ item.quantity }}</td>
        <td>${{ item.line_total }}</td>
      </tr>
    {% endfor %}
  </table>

  <div class="totals">
    <p>Subtotal: <strong id="subtotal-display">${{ subtotal }}</strong></p>
    <p>GST/HST (5%): <strong id="tax-display">${{ tax }}</strong></p>
    <p>Shipping: <strong id="shipping-display">${{ shipping }}</strong> (<span id="shipping-label">{{ shipping_label }}</span>)</p>
    <p><strong>Total: <span id="total-display">${{ total }}</span></strong></p>
  </div>

  <div class="buttons">
    {% if not insufficient_items %}
      <button type="submit" name="action" value="place_order" id="place-order-btn">Place Order (demo)</button>
    {% else %}
      <a href="{% url 'cart:cart_detail' %}">Go back to Cart and adjust quantities</a>
    {% endif %}

    <a href="{% url 'home:home' %}">Continue Shopping</a>
    <a href="{% url 'cart:cart_detail' %}">Back to Cart</a>
  </div>
  
  {# Error message for missing pickup location #}
  <div id="pickup-location-error" style="display: none; color: red; font-weight: bold; margin-top: 15px; padding: 10px; background: #ffe6e6; border: 1px solid #ff9999; border-radius: 4px;">
    Please select a pickup location before placing your order.
  </div>

</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const fulfillmentRadios = document.querySelectorAll('input[name="fulfillment_method"]');
  const shippingSection = document.getElementById('shipping-section');
  const pickupSection = document.getElementById('pickup-section');
  {% if form.pickup_location_id %}
  const pickupSelect = document.getElementById('{{ form.pickup_location_id.id_for_label }}');
  {% else %}
  const pickupSelect = document.getElementById('id_pickup_location_id');
  {% endif %}
  const pickupDetails = document.getElementById('pickup-location-details');
  
  // Pickup locations data for JavaScript
  const pickupLocations = {
    {% for location in pickup_locations %}
    {{ location.id }}: {
      name: "{{ location.name|escapejs }}",
      address1: "{{ location.address1|escapejs }}",
      address2: "{{ location.address2|default:''|escapejs }}",
      city: "{{ location.city|escapejs }}",
      province: "{{ location.province|escapejs }}",
      postal_code: "{{ location.postal_code|escapejs }}",
      country: "{{ location.country|escapejs }}",
      phone: "{{ location.phone|default:''|escapejs }}",
      instructions: "{{ location.instructions|default:''|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
  };
  
  function updateShippingCost() {
    const selectedMethod = document.querySelector('input[name="fulfillment_method"]:checked');
    const subtotalEl = document.getElementById('subtotal-display');
    const taxEl = document.getElementById('tax-display');
    const shippingEl = document.getElementById('shipping-display');
    const shippingLabelEl = document.getElementById('shipping-label');
    const totalEl = document.getElementById('total-display');
    
    if (!subtotalEl || !taxEl || !shippingEl || !totalEl) return;
    
    // Extract numeric values from the original display
    const subtotal = parseFloat('{{ subtotal }}');
    const tax = parseFloat('{{ tax }}');
    const originalShipping = parseFloat('{{ shipping }}');
    const originalShippingLabel = '{{ shipping_label|escapejs }}';
    
    let shipping = originalShipping;
    let shippingLabel = originalShippingLabel;
    
    // If pickup is selected, shipping is $0
    if (selectedMethod && selectedMethod.value === 'pickup') {
      shipping = 0;
      shippingLabel = 'No shipping (pickup order)';
    }
    
    const total = subtotal + tax + shipping;
    
    // Update display
    shippingEl.textContent = '$' + shipping.toFixed(2);
    if (shippingLabelEl) shippingLabelEl.textContent = shippingLabel;
    totalEl.textContent = '$' + total.toFixed(2);
  }
  
  function toggleFulfillmentSections() {
    const selectedMethod = document.querySelector('input[name="fulfillment_method"]:checked');
    if (selectedMethod && selectedMethod.value === 'pickup') {
      if (shippingSection) shippingSection.style.display = 'none';
      if (pickupSection) pickupSection.style.display = 'block';
      // Make shipping fields not required when pickup is selected
      if (shippingSection) {
        const shippingFields = shippingSection.querySelectorAll('input[required], select[required]');
        shippingFields.forEach(field => field.removeAttribute('required'));
      }
    } else {
      if (shippingSection) shippingSection.style.display = 'block';
      if (pickupSection) pickupSection.style.display = 'none';
      // Make shipping fields required when shipping is selected
      const requiredFields = ['ship_name', 'ship_address1', 'ship_city', 'ship_province', 'ship_postal_code'];
      requiredFields.forEach(fieldName => {
        const field = document.getElementById('id_' + fieldName);
        if (field) field.setAttribute('required', 'required');
      });
    }
    // Update shipping cost when method changes
    updateShippingCost();
  }
  
  function updatePickupDetails() {
    if (!pickupSelect || !pickupDetails) return;
    const selectedId = pickupSelect.value;
    if (selectedId && pickupLocations[selectedId]) {
      const loc = pickupLocations[selectedId];
      let html = '<h4>' + loc.name + '</h4>';
      html += '<p><strong>Address:</strong><br>';
      html += loc.address1;
      if (loc.address2) html += '<br>' + loc.address2;
      html += '<br>' + loc.city + ', ' + loc.province + ' ' + loc.postal_code;
      html += '<br>' + loc.country + '</p>';
      if (loc.phone) html += '<p><strong>Phone:</strong> ' + loc.phone + '</p>';
      if (loc.instructions) html += '<p><strong>Instructions:</strong> ' + loc.instructions + '</p>';
      pickupDetails.innerHTML = html;
      pickupDetails.style.display = 'block';
    } else {
      pickupDetails.style.display = 'none';
    }
  }
  
  // Initial setup - set default to shipping if nothing is checked
  if (!document.querySelector('input[name="fulfillment_method"]:checked')) {
    const shippingRadio = document.getElementById('id_fulfillment_method_0');
    if (shippingRadio) shippingRadio.checked = true;
  }
  toggleFulfillmentSections();
  
  // Listen for fulfillment method changes
  fulfillmentRadios.forEach(radio => {
    radio.addEventListener('change', function() {
      toggleFulfillmentSections();
      updateShippingCost();
    });
  });
  
  // Listen for pickup location selection
  if (pickupSelect) {
    pickupSelect.addEventListener('change', function() {
      updatePickupDetails();
      // Clear error when location is selected
      if (pickupLocationError) {
        pickupLocationError.style.display = 'none';
      }
      if (pickupSelect.style.border === '2px solid red') {
        pickupSelect.style.border = '';
      }
    });
    // Update on page load if a location is already selected
    if (pickupSelect.value) {
      updatePickupDetails();
    }
  }
  
  // Form validation before submission
  const form = document.querySelector('form');
  const placeOrderBtn = document.getElementById('place-order-btn');
  const pickupLocationError = document.getElementById('pickup-location-error');
  
  if (form && placeOrderBtn) {
    form.addEventListener('submit', function(e) {
      const selectedMethod = document.querySelector('input[name="fulfillment_method"]:checked');
      
      // Check if pickup is selected but no location is chosen
      if (selectedMethod && selectedMethod.value === 'pickup') {
        const pickupSelectValue = pickupSelect ? pickupSelect.value : '';
        if (!pickupSelectValue || pickupSelectValue === '') {
          e.preventDefault(); // Prevent form submission
          
          // Show error message
          if (pickupLocationError) {
            pickupLocationError.style.display = 'block';
            pickupLocationError.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
          
          // Highlight the pickup location dropdown
          if (pickupSelect) {
            pickupSelect.style.border = '2px solid red';
            pickupSelect.focus();
          }
          
          return false;
        }
      }
      
      // Hide error if validation passes
      if (pickupLocationError) {
        pickupLocationError.style.display = 'none';
      }
    });
  }
});
</script>

{% endif %}
{% endblock %}
