{% extends "base.html" %}
{% load static %}

{% block title %}Analytics Dashboard - Fitness Club{% endblock %}

{% block extra_css %}
<style>
  .dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
  }

  .dashboard-header {
    background: linear-gradient(135deg, #2d6a4f 0%, #1b4332 100%);
    color: white;
    padding: 30px;
    border-radius: 10px;
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }

  .dashboard-header h1 {
    margin: 0 0 10px 0;
    font-size: 2.5rem;
    color: white;
  }

  .dashboard-header p {
    margin: 0;
    opacity: 0.9;
    font-size: 1.1rem;
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    border-left: 4px solid #2d6a4f;
  }

  .stat-card h3 {
    margin: 0 0 10px 0;
    font-size: 0.9rem;
    color: #666;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .stat-card .value {
    font-size: 2rem;
    font-weight: bold;
    color: #2d6a4f;
    margin: 0;
  }

  .stat-card .sub-value {
    font-size: 0.9rem;
    color: #999;
    margin-top: 5px;
  }

  .charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 30px;
    margin-bottom: 30px;
  }

  .chart-card {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .chart-card h2 {
    margin: 0 0 20px 0;
    font-size: 1.5rem;
    color: #333;
    border-bottom: 2px solid #2d6a4f;
    padding-bottom: 10px;
  }

  .chart-container {
    position: relative;
    height: 300px;
    margin-top: 20px;
  }

  .chart-container.pie-chart {
    height: 350px;
  }

  .table-card {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }

  .table-card h2 {
    margin: 0 0 20px 0;
    font-size: 1.5rem;
    color: #333;
    border-bottom: 2px solid #2d6a4f;
    padding-bottom: 10px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  table th,
  table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
  }

  table th {
    background: #f8f9fa;
    font-weight: bold;
    color: #333;
  }

  table tr:hover {
    background: #f8f9fa;
  }

  .no-data {
    text-align: center;
    padding: 40px;
    color: #999;
    font-style: italic;
  }

  @media (max-width: 768px) {
    .dashboard-container {
      padding: 10px;
    }

    .dashboard-header h1 {
      font-size: 1.8rem;
    }

    .stats-grid {
      grid-template-columns: 1fr;
    }

    .charts-grid {
      grid-template-columns: 1fr;
    }

    .chart-container {
      height: 250px;
    }

    .chart-container.pie-chart {
      height: 300px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>üìä Analytics Dashboard</h1>
    <p>Business insights and key performance indicators</p>
  </div>

  <!-- Key Metrics -->
  <div class="stats-grid">
    <div class="stat-card">
      <h3>üí∞ Total Revenue</h3>
      <p class="value">${{ total_revenue|floatformat:2 }}</p>
      <p class="sub-value">All time</p>
    </div>
    <div class="stat-card">
      <h3>üìÖ Today's Revenue</h3>
      <p class="value">${{ today_revenue|floatformat:2 }}</p>
      <p class="sub-value">Today</p>
    </div>
    <div class="stat-card">
      <h3>üìÜ This Month</h3>
      <p class="value">${{ monthly_revenue|floatformat:2 }}</p>
      <p class="sub-value">Current month</p>
    </div>
    <div class="stat-card">
      <h3>üìà This Year</h3>
      <p class="value">${{ yearly_revenue|floatformat:2 }}</p>
      <p class="sub-value">Current year</p>
    </div>
    <div class="stat-card">
      <h3>üë• Active Members</h3>
      <p class="value">{{ active_members }}</p>
      <p class="sub-value">{{ new_members_this_month }} new this month</p>
    </div>
    <div class="stat-card">
      <h3>üõí Total Orders</h3>
      <p class="value">{{ total_orders }}</p>
      <p class="sub-value">{{ orders_today }} today, {{ orders_this_month }} this month</p>
    </div>
    <div class="stat-card">
      <h3>üì¶ Products</h3>
      <p class="value">{{ total_products }}</p>
      <p class="sub-value">{{ low_stock_products }} low stock, {{ out_of_stock_products }} out of stock</p>
    </div>
    <div class="stat-card">
      <h3>üë§ Total Users</h3>
      <p class="value">{{ total_users }}</p>
      <p class="sub-value">Registered accounts</p>
    </div>
  </div>

  <!-- Charts -->
  <div class="charts-grid">
    <!-- Monthly Revenue Chart -->
    <div class="chart-card">
      <h2>üìà Monthly Revenue Trend</h2>
      <div class="chart-container">
        <canvas id="revenueChart"></canvas>
      </div>
    </div>

    <!-- Membership Type Pie Chart -->
    <div class="chart-card">
      <h2>ü•ß Membership Type Distribution</h2>
      <div class="chart-container pie-chart">
        <canvas id="membershipChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Top Products Chart -->
  <div class="chart-card">
    <h2>üèÜ Top 5 Products by Revenue</h2>
    <div class="chart-container">
      <canvas id="productsChart"></canvas>
    </div>
  </div>

  <!-- Order Status Table -->
  <div class="table-card">
    <h2>üìã Order Status Breakdown</h2>
    {% if order_status_breakdown %}
    <table>
      <thead>
        <tr>
          <th>Status</th>
          <th>Count</th>
        </tr>
      </thead>
      <tbody>
        {% for status in order_status_breakdown %}
        <tr>
          <td>{{ status.status|title }}</td>
          <td>{{ status.count }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="no-data">No order data available</div>
    {% endif %}
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
  // Monthly Revenue Line Chart
  const revenueCtx = document.getElementById('revenueChart');
  if (revenueCtx) {
    new Chart(revenueCtx, {
      type: 'line',
      data: {
        labels: {{ monthly_labels|safe }},
        datasets: [{
          label: 'Monthly Revenue ($)',
          data: {{ monthly_revenue_values|safe }},
          borderColor: '#2d6a4f',
          backgroundColor: 'rgba(45, 106, 79, 0.1)',
          borderWidth: 3,
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top'
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: function(context) {
                return '$' + context.parsed.y.toFixed(2);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '$' + value.toFixed(0);
              }
            }
          }
        }
      }
    });
  }

  // Membership Type Pie Chart
  const membershipCtx = document.getElementById('membershipChart');
  if (membershipCtx && {{ membership_labels|length }} > 0) {
    new Chart(membershipCtx, {
      type: 'pie',
      data: {
        labels: {{ membership_labels|safe }},
        datasets: [{
          data: {{ membership_counts|safe }},
          backgroundColor: {{ membership_chart_colors|safe }},
          borderWidth: 2,
          borderColor: '#fff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'bottom'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((value / total) * 100).toFixed(1);
                return label + ': ' + value + ' (' + percentage + '%)';
              }
            }
          }
        }
      }
    });
  } else if (membershipCtx) {
    membershipCtx.parentElement.innerHTML = '<div class="no-data">No membership data available</div>';
  }

  // Top Products Bar Chart
  const productsCtx = document.getElementById('productsChart');
  if (productsCtx && {{ top_product_names|length }} > 0) {
    new Chart(productsCtx, {
      type: 'bar',
      data: {
        labels: {{ top_product_names|safe }},
        datasets: [{
          label: 'Revenue ($)',
          data: {{ top_product_revenue|safe }},
          backgroundColor: '#2d6a4f',
          borderColor: '#1b4332',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: true,
            position: 'top'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                return '$' + context.parsed.y.toFixed(2);
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return '$' + value.toFixed(0);
              }
            }
          }
        }
      }
    });
  } else if (productsCtx) {
    productsCtx.parentElement.innerHTML = '<div class="no-data">No product sales data available</div>';
  }
</script>
{% endblock %}

